#!/bin/bash

# 项目地址
REPO_URL="https://github.com/yourusername/yourproject.git"
# 脚本存放目录
SCRIPTS_DIR="/etc/mihomo/scripts"

# 日志文件
LOG_FILE="/var/log/mihomo_update.log"

# 用于输出日志
function log_message() {
    echo "$1" | tee -a "$LOG_FILE"
}

# 清空旧的日志文件
ture > "$LOG_FILE"

log_message "===== 开始更新脚本 ====="

# 检查脚本目录是否存在
if [ ! -d "$SCRIPTS_DIR" ]; then
    log_message "脚本目录不存在，正在创建目录..."
    sudo mkdir -p "$SCRIPTS_DIR" || { log_message "创建目录失败！"; exit 1; }
fi

# 进入脚本目录
cd "$SCRIPTS_DIR" || { log_message "无法进入脚本目录！"; exit 1; }

# 拉取最新的脚本
log_message "从 GitHub 仓库拉取最新脚本..."
if [ -d "$SCRIPTS_DIR/.git" ]; then
    # 如果是一个 git 仓库，执行 pull 操作
    git pull origin main || { log_message "拉取脚本失败！"; exit 1; }
else
    # 如果不是 git 仓库，克隆仓库
    git clone "$REPO_URL" "$SCRIPTS_DIR" || { log_message "克隆仓库失败！"; exit 1; }
fi

# 设置脚本文件权限
log_message "设置脚本文件权限 ..."
sudo chmod 755 "$SCRIPTS_DIR"/* || { log_message "设置脚本权限失败！"; exit 1; }

log_message "===== 脚本更新完成 ====="

# 返回主菜单
echo "脚本更新完成！请检查日志文件：$LOG_FILE"